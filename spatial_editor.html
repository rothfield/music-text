<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spatial Music Notation Editor</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .editor-container {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 2rem;
        }
        
        .toolbar {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #dee2e6;
        }
        
        .btn.active {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }
        
        .music-lines {
            font-family: 'Courier New', Consolas, 'Liberation Mono', monospace;
            font-size: 18px;
            line-height: 1.2;
            background: #fdfdfd;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 20px;
            position: relative;
        }
        
        .line {
            height: 1.5em;
            margin: 0;
            padding: 0 10px;
            outline: none;
            white-space: pre;
            overflow: hidden;
        }
        
        .upper-line {
            color: #666;
            border-bottom: 1px solid #eee;
        }
        
        .main-line {
            font-weight: 500;
            color: #000;
            background: white;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        
        .lower-line {
            color: #666;
            border-top: 1px solid #eee;
        }
        
        .line:focus {
            background: #f0f8ff;
        }
        
        .instructions {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 2rem;
            font-size: 14px;
        }
        
        .output-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            margin-top: 2rem;
        }
        
        .output-content {
            background: white;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', Consolas, monospace;
            white-space: pre-wrap;
            border: 1px solid #dee2e6;
            margin-top: 10px;
        }
        
        .char-counter {
            position: absolute;
            top: 5px;
            right: 10px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>üéº Spatial Music Notation Editor</h1>
    
    <div class="instructions">
        <h3>How to use:</h3>
        <p><strong>Main line:</strong> Type your music notation (1 2 3 4 5 or C D E F G)</p>
        <p><strong>Upper line:</strong> Add dots (.) above notes for upper octave</p>
        <p><strong>Lower line:</strong> Add dots (.) below notes for lower octave, dashes (-) for slurs</p>
        <p><strong>Tip:</strong> Characters align vertically - position matters!</p>
        <p><strong>Example:</strong></p>
        <pre>. . .     (upper octave on 1,2,3)
1 2 3 4 5 (main notes)
-----     (slur over 1,2,3,4,5)</pre>
    </div>
    
    <div class="editor-container">
        <div class="toolbar">
            <button class="btn" onclick="insertChar('.')" title="Insert dot">‚Ä¢ Dot</button>
            <button class="btn" onclick="insertChar('-')" title="Insert dash">- Dash</button>
            <button class="btn" onclick="insertChar(' ')" title="Insert space">‚éµ Space</button>
            <button class="btn" onclick="alignLines()" title="Make all lines same length">‚ü∑ Align</button>
            <button class="btn" onclick="clearAll()" title="Clear all lines">‚úñ Clear</button>
            <button class="btn" onclick="loadExample()" title="Load example">üìù Example</button>
        </div>
        
        <div class="music-lines">
            <div class="char-counter" id="charCounter">Position: 0</div>
            
            <div class="line upper-line" 
                 contenteditable="true" 
                 id="upperLine" 
                 spellcheck="false"
                 placeholder="Upper octave dots: . . ."
                 data-line="upper"></div>
                 
            <div class="line main-line" 
                 contenteditable="true" 
                 id="mainLine" 
                 spellcheck="false"
                 placeholder="Main notes: 1 2 3 4 5"
                 data-line="main"></div>
                 
            <div class="line lower-line" 
                 contenteditable="true" 
                 id="lowerLine" 
                 spellcheck="false"
                 placeholder="Lower octave dots, slurs: . . . - - -"
                 data-line="lower"></div>
        </div>
    </div>
    
    <div class="output-section">
        <h3>Converted Music-Text Output:</h3>
        <button class="btn" onclick="convertToMusicText()">üîÑ Convert</button>
        <div id="outputContent" class="output-content">
Type in the spatial editor above, then click Convert...
        </div>
    </div>

    <script>
        let currentLine = null;
        let cursorPosition = 0;
        
        // Initialize
        document.querySelectorAll('.line').forEach(line => {
            line.addEventListener('focus', handleLineFocus);
            line.addEventListener('input', handleLineInput);
            line.addEventListener('keydown', handleKeyDown);
            line.addEventListener('click', updateCursorPosition);
        });
        
        function handleLineFocus(event) {
            currentLine = event.target;
            updateCursorPosition();
        }
        
        function handleLineInput(event) {
            // Keep lines synchronized in length
            setTimeout(() => {
                updateCursorPosition();
                convertToMusicText();
            }, 10);
        }
        
        function handleKeyDown(event) {
            // Handle special keys
            if (event.key === 'ArrowUp') {
                event.preventDefault();
                moveCursorToLine('upper');
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                moveCursorToLine('lower');
            }
        }
        
        function updateCursorPosition() {
            if (!currentLine) return;
            
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                cursorPosition = range.startOffset;
                document.getElementById('charCounter').textContent = `Position: ${cursorPosition}`;
            }
        }
        
        function moveCursorToLine(direction) {
            let targetLine;
            const currentLineType = currentLine ? currentLine.dataset.line : 'main';
            
            if (direction === 'upper') {
                if (currentLineType === 'main') targetLine = document.getElementById('upperLine');
                else if (currentLineType === 'lower') targetLine = document.getElementById('mainLine');
            } else if (direction === 'lower') {
                if (currentLineType === 'upper') targetLine = document.getElementById('mainLine');
                else if (currentLineType === 'main') targetLine = document.getElementById('lowerLine');
            }
            
            if (targetLine) {
                targetLine.focus();
                
                // Set cursor position
                const selection = window.getSelection();
                const range = document.createRange();
                const textLength = targetLine.textContent.length;
                const pos = Math.min(cursorPosition, textLength);
                
                if (targetLine.firstChild) {
                    range.setStart(targetLine.firstChild, pos);
                    range.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                
                currentLine = targetLine;
            }
        }
        
        function insertChar(char) {
            if (!currentLine) {
                currentLine = document.getElementById('mainLine');
                currentLine.focus();
            }
            
            // Insert character at cursor position
            document.execCommand('insertText', false, char);
            updateCursorPosition();
            convertToMusicText();
        }
        
        function alignLines() {
            const upper = document.getElementById('upperLine').textContent;
            const main = document.getElementById('mainLine').textContent;
            const lower = document.getElementById('lowerLine').textContent;
            
            const maxLength = Math.max(upper.length, main.length, lower.length);
            
            document.getElementById('upperLine').textContent = upper.padEnd(maxLength, ' ');
            document.getElementById('mainLine').textContent = main.padEnd(maxLength, ' ');
            document.getElementById('lowerLine').textContent = lower.padEnd(maxLength, ' ');
            
            convertToMusicText();
        }
        
        function clearAll() {
            document.getElementById('upperLine').textContent = '';
            document.getElementById('mainLine').textContent = '';
            document.getElementById('lowerLine').textContent = '';
            document.getElementById('outputContent').textContent = 'All lines cleared.';
        }
        
        function loadExample() {
            document.getElementById('upperLine').textContent = '. . .     .  ';
            document.getElementById('mainLine').textContent = '1 2 3 4 5 6 7';
            document.getElementById('lowerLine').textContent = '-----       . ';
            convertToMusicText();
        }
        
        function convertToMusicText() {
            const upper = document.getElementById('upperLine').textContent;
            const main = document.getElementById('mainLine').textContent;
            const lower = document.getElementById('lowerLine').textContent;
            const output = document.getElementById('outputContent');
            
            try {
                let result = '';
                const maxLength = Math.max(upper.length, main.length, lower.length);
                
                let inSlur = false;
                let slurNotes = [];
                
                for (let i = 0; i < maxLength; i++) {
                    const upperChar = i < upper.length ? upper[i] : ' ';
                    const mainChar = i < main.length ? main[i] : ' ';
                    const lowerChar = i < lower.length ? lower[i] : ' ';
                    
                    // Process main character if it's a note
                    if (/[1-7CDEFGABSRGMPDNcdefgabsrgmpdn]/.test(mainChar)) {
                        let noteStr = mainChar;
                        
                        // Add octave markings
                        if (upperChar === '.') {
                            noteStr += "'";
                        }
                        if (lowerChar === '.') {
                            noteStr += ",";
                        }
                        
                        // Handle slurs
                        if (lowerChar === '-') {
                            if (!inSlur) {
                                inSlur = true;
                                slurNotes = [noteStr];
                            } else {
                                slurNotes.push(noteStr);
                            }
                        } else {
                            if (inSlur && slurNotes.length > 0) {
                                // End slur
                                result += slurNotes.join('_') + ' ';
                                inSlur = false;
                                slurNotes = [];
                            }
                            result += noteStr + ' ';
                        }
                    } else if (/[\s\-|]/.test(mainChar)) {
                        // Handle spaces, dashes, barlines in main line
                        if (inSlur && slurNotes.length > 0) {
                            // End slur at space
                            result += slurNotes.join('_') + ' ';
                            inSlur = false;
                            slurNotes = [];
                        }
                        if (mainChar.trim()) {
                            result += mainChar + ' ';
                        } else {
                            result += ' ';
                        }
                    }
                }
                
                // Close any remaining slur
                if (inSlur && slurNotes.length > 0) {
                    result += slurNotes.join('_');
                }
                
                // Clean up result
                result = result.replace(/\s+/g, ' ').trim();
                
                output.textContent = result || 'No music notation detected';
                
            } catch (error) {
                output.textContent = `Error: ${error.message}`;
            }
        }
        
        // Auto-convert on any change
        setInterval(() => {
            convertToMusicText();
        }, 1000);
        
        // Initial load
        loadExample();
    </script>
</body>
</html>