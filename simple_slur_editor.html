<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Slur Editor</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .section {
            border: 1px solid #dee2e6;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .slur-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .slur-btn:hover {
            background: #0056b3;
        }
        
        .slur-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .wysiwyg-editor {
            padding: 20px;
            min-height: 200px;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 18px;
            line-height: 2;
            outline: none;
            background: white;
        }
        
        .wysiwyg-editor:focus {
            background: #fafafa;
        }
        
        .readonly-textarea {
            padding: 20px;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 16px;
            line-height: 1.5;
            background: #f8f9fa;
            border: none;
            resize: none;
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
        }
        
        /* Slur visualization */
        .slur {
            position: relative;
            display: inline-block;
            border-top: 2px solid #333;
            border-radius: 50% / 100% 100% 0 0;
            padding-top: 0.3em;
            margin-top: -0.3em;
        }
        
        .slur::before,
        .slur::after {
            content: '';
            position: absolute;
            top: 0;
            width: 1px;
            height: 0.3em;
            background: white;
        }
        
        .slur::before { left: -1px; }
        .slur::after { right: -1px; }
        
        .instructions {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 2rem;
            font-size: 14px;
        }
        
        .clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        
        .clear-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <h1>ðŸŽµ Simple Slur Editor</h1>
    
    <div class="instructions">
        <h3>How to use:</h3>
        <p>1. <strong>Type music notation</strong> in the left editor (1 2 3 4 5 or C D E F G)</p>
        <p>2. <strong>Select notes</strong> you want to slur together</p>
        <p>3. <strong>Click "Add Slur"</strong> button</p>
        <p>4. <strong>Right side</strong> shows the music-text format with underscores for slurs</p>
        <p><strong>Example:</strong> Type "1 2 3 4 5", select "1 2 3", click Add Slur â†’ becomes "1_2_3 4 5"</p>
    </div>
    
    <div class="editor-container">
        <!-- WYSIWYG Editor -->
        <div class="section">
            <div class="section-header">
                Visual Editor
                <div>
                    <button class="slur-btn" id="slurBtn" onclick="addSlur()" disabled>
                        Add Slur âŒ’
                    </button>
                    <button class="clear-btn" onclick="clearAll()">
                        Clear
                    </button>
                </div>
            </div>
            <div id="wysiwygEditor" 
                 class="wysiwyg-editor" 
                 contenteditable="true" 
                 spellcheck="false"
                 placeholder="Type your music notation here...">
1 2 3 4 5 6 7
            </div>
        </div>
        
        <!-- Music-Text Output -->
        <div class="section">
            <div class="section-header">
                Music-Text Output
                <button class="slur-btn" onclick="copyToClipboard()">
                    Copy
                </button>
            </div>
            <textarea id="musicTextOutput" 
                      class="readonly-textarea" 
                      readonly
                      placeholder="Music-text format will appear here..."></textarea>
        </div>
    </div>

    <script>
        const wysiwygEditor = document.getElementById('wysiwygEditor');
        const musicTextOutput = document.getElementById('musicTextOutput');
        const slurBtn = document.getElementById('slurBtn');
        
        // Initialize
        wysiwygEditor.addEventListener('input', handleInput);
        wysiwygEditor.addEventListener('selectionchange', handleSelectionChange);
        document.addEventListener('selectionchange', handleSelectionChange);
        
        function handleInput() {
            updateMusicTextOutput();
        }
        
        function handleSelectionChange() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            // Enable/disable slur button based on selection
            if (selectedText && hasMusicalContent(selectedText)) {
                slurBtn.disabled = false;
                slurBtn.textContent = `Add Slur âŒ’ ("${selectedText.substring(0, 10)}...")`;
            } else {
                slurBtn.disabled = true;
                slurBtn.textContent = 'Add Slur âŒ’';
            }
        }
        
        function hasMusicalContent(text) {
            return /[1-7CDEFGABSRGMPDNcdefgabsrgmpdn]/.test(text);
        }
        
        function addSlur() {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const selectedText = selection.toString().trim();
            
            if (!selectedText || !hasMusicalContent(selectedText)) return;
            
            // Check if already slurred
            const container = range.commonAncestorContainer;
            const parentElement = container.nodeType === Node.ELEMENT_NODE ? container : container.parentNode;
            
            if (parentElement.classList && parentElement.classList.contains('slur')) {
                // Remove slur
                const textNode = document.createTextNode(parentElement.textContent);
                parentElement.parentNode.replaceChild(textNode, parentElement);
                
                // Restore selection
                const newRange = document.createRange();
                newRange.selectNodeContents(textNode);
                selection.removeAllRanges();
                selection.addRange(newRange);
            } else {
                // Add slur
                const span = document.createElement('span');
                span.className = 'slur';
                span.textContent = selectedText;
                
                range.deleteContents();
                range.insertNode(span);

                // Reselect the slurred text
                selection.removeAllRanges();
                const newRange = document.createRange();
                newRange.selectNodeContents(span);
                selection.addRange(newRange);
            }
            
            updateMusicTextOutput();
            handleSelectionChange(); // Update button state
        }
        
        function clearAll() {
            wysiwygEditor.innerHTML = '1 2 3 4 5 6 7';
            updateMusicTextOutput();
            handleSelectionChange();
        }
        
        function updateMusicTextOutput() {
            try {
                // Generate 2-line spatial format for existing lexer
                const { slurLine, noteLine } = generateSpatialFormat();
                
                let result = '';
                if (slurLine.trim()) {
                    result += slurLine + '\n';
                }
                result += noteLine;
                
                musicTextOutput.value = result;
                
            } catch (error) {
                musicTextOutput.value = `Error: ${error.message}`;
            }
        }
        
        function generateSpatialFormat() {
            let noteLine = '';
            let slurLine = '';
            
            function processNode(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    noteLine += text;
                    // Add spaces to slur line for unslurred content
                    slurLine += ' '.repeat(text.length);
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    if (node.classList.contains('slur')) {
                        const slurContent = node.textContent;
                        noteLine += slurContent;
                        
                        // Generate underscores for slur line
                        for (let i = 0; i < slurContent.length; i++) {
                            const char = slurContent[i];
                            if (/[1-7CDEFGABSRGMPDNcdefgabsrgmpdn]/.test(char)) {
                                slurLine += '_';
                            } else {
                                slurLine += char; // preserve spaces/dashes in slur
                            }
                        }
                    } else {
                        // Process child nodes recursively
                        for (let child of node.childNodes) {
                            processNode(child);
                        }
                    }
                }
            }
            
            // Process all content
            for (let node of wysiwygEditor.childNodes) {
                processNode(node);
            }
            
            return { 
                slurLine: slurLine.trimRight(), 
                noteLine: noteLine.trim()
            };
        }
        
        function copyToClipboard() {
            musicTextOutput.select();
            document.execCommand('copy');
            
            // Visual feedback
            const originalText = document.querySelector('.section-header button[onclick="copyToClipboard()"]').textContent;
            document.querySelector('.section-header button[onclick="copyToClipboard()"]').textContent = 'Copied!';
            setTimeout(() => {
                document.querySelector('.section-header button[onclick="copyToClipboard()"]').textContent = originalText;
            }, 1000);
        }
        
        // Initialize output
        updateMusicTextOutput();
    </script>
</body>
</html>