/*************************************************
 * THIS FILE IS TO STYLE THE CODEMIRROR TEXT EDITOR
 *
 * All styles in this file are specifically for the
 * CodeMirror editor instance and its syntax highlighting
 **************************************************/

/* CodeMirror Editor Styles */

/* Base CodeMirror Editor */
.CodeMirror {
    width: 100%;
    min-height: 80px;
    padding: 8px;
    border: none;
    border-bottom: 1px solid #e1e5e9;
    font-family: 'SF Mono', Monaco, Consolas, monospace;
    font-size: 14px;
    line-height: 1.4;
    resize: vertical;
    outline: none;
    background: white;
}

.CodeMirror-focused {
    border-bottom-color: royalblue;
}

.CodeMirror-scroll {
    min-height: 80px;
}

/* Enhanced line height for notation lines to prevent collisions */
.cm-editor .cm-line {
    line-height: 2.5em;
}

/* Content line highlighting with doremi font */
.CodeMirror-linebackground.content-line {
    background: aliceblue !important;
    padding-left: 0.5em;
}

.CodeMirror-line.content-line {
    font-family: sans-serif !important;
    font-size: 1.6em !important;
    line-height: 1.8em !important;
}

.text-line {
    background: #fafafa !important;
}

/* Lyrics styling from doremi */
.CodeMirror-linebackground.lyrics-line {
    background: cornsilk !important;
    padding-left: 0.5em;
}

.CodeMirror-line.lyrics-line {
    font-family: serif !important;
    font-size: 1.4em !important;
    font-style: italic;
    color: dimgray;
    line-height: 1.6em !important;
}

/* Directive lines (Title, Composer, etc) */
.CodeMirror-linebackground.directive-line {
    background: honeydew !important;
    padding-left: 0.5em;
}

.CodeMirror-line.directive-line {
    font-family: sans-serif !important;
    font-weight: bold;
    font-size: 1.2em !important;
    line-height: 1.6em !important;
}

/* Line spacing for proper music notation */
.CodeMirror-line.content-line {
    line-height: 2em;
    padding-left: 1em;
}

/* Pure CSS octave indicators using --octave variable */
/* Notes need to be relatively positioned for absolute children */
.cm-music-note {
    position: relative;
}

/* Upper octave +1: bullet sits on top of bbox */
.cm-music-note[style*="--octave: \"1\""]::before,
.cm-music-note[style*="--octave:\"1\""]::before {
    content: '•';
    position: absolute;
    top: -0.3em;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.2em;
    color: #0066cc;
    font-weight: bold;
}

/* Upper octave +2: colon on top of bbox */
.cm-music-note[style*="--octave: \"2\""]::before,
.cm-music-note[style*="--octave:\"2\""]::before {
    content: ':';
    position: absolute;
    top: -0.4em;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.0em;
    color: #0066cc;
    font-weight: bold;
}

/* Lower octave -1: bullet hanging off bottom of bbox */
.cm-music-note[style*="--octave: \"-1\""]::after,
.cm-music-note[style*="--octave:\"-1\""]::after {
    content: '•';
    position: absolute;
    bottom: -0.7em;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.2em;
    color: #cc6600;
    font-weight: bold;
}

/* Lower octave -2: colon hanging from bottom of bbox */
.cm-music-note[style*="--octave: \"-2\""]::after,
.cm-music-note[style*="--octave:\"-2\""]::after {
    content: ':';
    position: absolute;
    bottom: -0.8em;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.0em;
    color: #cc6600;
    font-weight: bold;
}

/* CodeMirror XML Syntax Highlighting */
.CodeMirror .cm-tag {
    color: forestgreen !important;
    font-weight: bold;
}
.CodeMirror .cm-attribute {
    color: mediumorchid !important;
}
.CodeMirror .cm-string {
    color: midnightblue !important;
}
.CodeMirror .cm-atom {
    color: chocolate !important;
}
.CodeMirror .cm-bracket {
    color: crimson !important;
    font-weight: bold;
}

/* CodeMirror Music Token Syntax Highlighting */
.CodeMirror .cm-note,
.CodeMirror .cm-dash {
    color: mediumvioletred !important;
    font-weight: bold;
    background: yellow !important;
    /* Maintain monospace width for bold pitches */
    font-family: 'SF Mono', Monaco, Consolas, 'Courier New', monospace !important;
    letter-spacing: 0;
    font-synthesis: none;
    text-rendering: optimizeSpeed;
    /* Ensure consistent character width */
    font-variant-numeric: tabular-nums;
    font-feature-settings: "tnum";
}

.CodeMirror .cm-note[title] {
    cursor: help;
}
/* Individual barline types */
.CodeMirror .cm-single-barline,
.CodeMirror .cm-double-barline,
.CodeMirror .cm-final-barline,
.CodeMirror .cm-repeat-start-barline,
.CodeMirror .cm-repeat-end-barline,
.CodeMirror .cm-repeat-both-barline {
    color: #4b0082 !important;
    font-weight: bold;
    background: #e6ccff !important;
}
/* Dash styling now handled by combined rule above */
.CodeMirror .cm-syllable {
    color: #b8860b !important;
    background: #fff87d !important;
}
.CodeMirror .cm-whitespace {
    background: #f0f8ff !important;
}
.CodeMirror .cm-rest {
    color: dimgray !important;
    background: #e0e0e0 !important;
}
.CodeMirror .cm-breath-mark {
    color: #008b8b !important;
    background: #e0ffff !important;
}
.CodeMirror .cm-music-unparsed {
    background: #ff6b6b !important;
    color: white !important;
    animation: blink 1.5s linear infinite;
    font-weight: bold;
}
.CodeMirror .cm-music-unknown {
    background: darkorange !important;
    color: white !important;
    font-weight: bold;
    border: 2px solid orangered !important;
}

/* Music Text CodeMirror Syntax Highlighting Classes */
/* These classes are applied by CodeMirror's custom mode */

/* Whitespace tokens - Red background as requested */
.cm-whitespace {
    background-color: red !important;
    color: white !important;
}

/* Other token types can be styled here */
.cm-note,
.cm-dash {
  position: relative;
  display: inline;      /* allow natural width instead of forcing 1ch */
  line-height: 1;
  color: #22863a;       /* green - main note color */
  font-weight: bold;
}

/* Beat and Loop Display - Ultra-Generalized CSS using Custom Properties */

/* Division number display (centered above middle element) */
.cm-note[style*="--display-division"]::before {
    content: var(--display-division) !important;
    position: absolute !important;
    top: -1.4em !important;
    left: 50% !important;
    transform: translateX(-50%) !important;
    text-align: center !important;
    font-family: serif !important;
    font-size: 0.7em !important;
    font-style: italic !important;
    font-weight: normal !important;
    color: dimgray !important;
    z-index: 11 !important;
    pointer-events: none !important;
}

/* Beat loop arc - attached to first element (note or dash) of beat group */
.cm-note.beat-start[style*="--beat-loop-length"]::after,
.cm-dash.beat-start[style*="--beat-loop-length"]::after {
    content: '' !important;
    position: absolute !important;
    top: calc(100% - 0.1em) !important;  /* Slightly overlap character bounding box */
    left: -0.1em !important;
    /* Calculate width based on number of characters only */
    width: calc(var(--beat-loop-length) * 1ch) !important;
    height: 0.25em !important;  /* Much shallower, like a tea saucer */
    border: 2px solid orange !important;  /* orange - beat grouping arcs */
    border-top: none !important;
    border-bottom-left-radius: 50% 100% !important;  /* Flatter curve */
    border-bottom-right-radius: 50% 100% !important;  /* Flatter curve */
    z-index: 10 !important;
    pointer-events: none !important;
}

/* Legacy support for --lower-loop-char-count */
.cm-note[style*="--lower-loop-char-count"]::after {
    content: '' !important;
    position: absolute !important;
    top: calc(100% - 0.1em) !important;  /* Slightly overlap character bounding box */
    left: -0.1em !important;
    width: calc(var(--lower-loop-char-count) * 1ch) !important;
    height: 0.25em !important;  /* Much shallower, like a tea saucer */
    border: 2px solid orange !important;  /* orange - beat grouping arcs */
    border-top: none !important;
    border-bottom-left-radius: 50% 100% !important;  /* Flatter curve */
    border-bottom-right-radius: 50% 100% !important;  /* Flatter curve */
    z-index: 10 !important;
    pointer-events: none !important;
}

/* tuplet number above the note */
.cm-note::before,
.cm-unknown::before{
  content: var(--tuplet, "");
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  top: -0.9em;
  font-size: 0.7em;
  line-height: 1;
  opacity: .8;
  pointer-events: none;
}

/* Individual barline types */
.cm-single-barline,
.cm-double-barline,
.cm-final-barline,
.cm-repeat-start-barline,
.cm-repeat-end-barline,
.cm-repeat-both-barline {
    color: mediumorchid;      /* purple - barlines */
    font-weight: bold;
}

.cm-syllable {
    color: chocolate;      /* orange - lyrics/syllables */
    font-weight: bold;
}

.cm-rest {
    color: dimgray;      /* gray - rests */
    font-weight: bold;
}

.cm-breath-mark {
    color: darkcyan;      /* cyan - breath marks */
    font-weight: bold;
}

.cm-unknown {
    color: darkorange;                /* bright orange - unknown elements */
    font-weight: bold;
    background-color: bisque;     /* light peach background */
}

/* Beat group indicators - make underscore characters transparent but still present */
.cm-beat-group-indicator {
    color: rgba(0, 0, 0, 0.2); /* 20% opacity - visible but faded */
    user-select: none;
}

/* Beat group role-specific styling for notes */
.cm-note-beat-group-start {
    position: relative;
    color: forestgreen;
    font-weight: bold;
}

.cm-note-beat-group-start::after {
    content: "";
    position: absolute;
    bottom: -1.2em;
    left: 0;
    right: 0;
    border-bottom: 0.1em solid #0366d6;
    border-bottom-left-radius: 0.8em;
    border-left: 1px solid white;
    padding-bottom: 0.75em;
}

.cm-note-beat-group-middle {
    position: relative;
    color: forestgreen;
    font-weight: bold;
}

.cm-note-beat-group-middle::after {
    content: "";
    position: absolute;
    bottom: -1.2em;
    left: 0;
    right: 0;
    border-bottom: 0.1em solid #0366d6;
    padding-bottom: 0.75em;
}

.cm-note-beat-group-end {
    position: relative;
    color: forestgreen;
    font-weight: bold;
}

.cm-note-beat-group-end::after {
    content: "";
    position: absolute;
    bottom: -1.2em;
    left: 0;
    right: 0;
    border-bottom: 0.1em solid #0366d6;
    border-bottom-right-radius: 0.8em;
    border-right: 1px solid white;
    padding-bottom: 0.75em;
}

/* Slur indicators - make underscore characters visually disappear */
.cm-slur-indicator {
    color: transparent;
    user-select: none;
}

/* Slur notes - notes that are within slur spans */
.cm-note-slur {
    color: deepskyblue;
    font-weight: 500;
}

/* Collision prevention for descenders (g, j, p, q, y) */
.cm-note.has-descender {
    padding-bottom: 0.3em;
}

/* Additional clearance for beat group arcs when descenders are present */
.cm-note.beat-group-start.has-descender::after {
    bottom: -0.8em;
}

/* Beat group notes - notes that are part of a beat group */
.cm-note.beat-group-start {
    position: relative;
}

/* Slur notes - notes that are part of a slur */
.cm-note.slur-start {
    position: relative;
}

/* Create spanning arc from start note across the entire beat group */
/* Based on DoReMiScript's span.beat.looped pattern */
.cm-note.beat-group-start::after {
    content: '';
    position: absolute;
    bottom: 1.05em;
    left: 0;
    border-bottom: 0.1em solid #0366d6;
    border-top: none;
    border-left: 1px solid white;
    border-right: 1px solid white;
    border-bottom-left-radius: 0.8em;
    border-bottom-right-radius: 0.8em;
    padding-bottom: 0.75em;
    width: 1em;
    z-index: 1;
    pointer-events: none;
}

/* Create spanning arc from start note across the entire slur (upper arc) */
/* Mirror of beat group pattern but for upper arcs */
.cm-note.slur-start::after {
    content: '';
    position: absolute;
    top: -0.2em;
    left: 0;
    border-top: 0.1em solid #d73a49;
    border-bottom: none;
    border-left: 1px solid white;
    border-right: 1px solid white;
    border-top-left-radius: 0.8em;
    border-top-right-radius: 0.8em;
    padding-top: 0.75em;
    z-index: 1;
    pointer-events: none;
}

/* Beat group dynamic width using CSS custom properties */
.cm-note.beat-group-start::after {
    width: var(--beat-group-width, 1em);
}

/* Dynamic loop styling - replaces thousands of redundant classes */
.cm-note-in-loop,
.cm-dash-loop,
.cm-note-loop {
    position: relative;
    color: forestgreen;
    font-weight: bold;
}

/* Dynamic arc rendering using CSS custom properties */
.cm-dash-loop::after,
.cm-note-loop::after {
    content: '';
    position: absolute;
    top: 0.8em;
    left: 0;
    border-bottom: 0.1em solid #0366d6;
    border-top: none;
    border-left: 0.1em solid #0366d6;
    border-right: 0.1em solid #0366d6;
    border-bottom-left-radius: 0.5em;
    border-bottom-right-radius: 0.5em;
    height: 0.25em;
    width: var(--loop-width, 1em);
    z-index: 1;
    pointer-events: none;
}

/* Dynamic slur width using CSS custom properties */
.cm-note.slur-start::after {
    width: var(--slur-width, 1.5em);
}

/* Implicit beat group highlighting - for spatially-delimited beats */
/* Highlight notes in implicit beat groups with subtle background */
.cm-note.in-implicit-beat {
    background-color: cornsilk;
    border-radius: 3px;
    padding: 1px 2px;
}

/* Start note gets slightly stronger highlight */
.cm-note.implicit-beat-start {
    position: relative;
    background-color: papayawhip;
    border-radius: 3px;
    padding: 1px 2px;
}

/* End note styling */
.cm-note.implicit-beat-end {
    background-color: moccasin;
    border-radius: 3px;
    padding: 1px 2px;
}

/* Create spanning arc for implicit beats - centered smile under the characters */
.cm-note.implicit-beat-start::after {
    content: '';
    position: absolute;
    bottom: -0.8em;  /* Hang below the text baseline */
    left: 0;
    width: var(--implicit-beat-width, 2ch);  /* Width based on character count */
    height: 0.6em;  /* Height of the arc */
    border: 2px solid #ff9800;
    border-top: none;
    border-bottom-left-radius: 50%;
    border-bottom-right-radius: 50%;
    z-index: 1;
    pointer-events: none;
}

/* Highlight notes in slurs with subtle background */
.cm-note.in-slur {
    background-color: mistyrose;
    border-radius: 3px;
    padding: 1px 2px;
}

/* Start note gets slightly stronger highlight */
.cm-note.slur-start {
    background-color: pink;
    border-radius: 3px;
    padding: 1px 2px;
}

/* End note styling */
.cm-note.slur-end {
    background-color: lightpink;
    border-radius: 3px;
    padding: 1px 2px;
}

/* Mordent styling - based on DoReMiScript patterns */
.cm-mordent {
    position: absolute;
    font-size: 1.5em;
    top: 0.4em;
    left: 0.13em;
    z-index: 2;
    font-family: 'Bravura', serif;
    font-weight: normal;
    color: mediumorchid;
}

/* Enhanced mordent with Bravura symbol */
.cm-mordent::before {
    content: "\E56C"; /* Bravura mordent symbol */
    display: inline-block;
}

/* Alternative mordent symbols */
.cm-mordent.short::before {
    content: "~";
}

.cm-mordent.inverted::before {
    content: "⌐";
}

/* Cursor style for elements with tooltips - keep default cursor */
.cm-note[data-tooltip] {
    cursor: default;
}

/* Make source octave markers invisible since they're displayed via consumed element CSS */
.cm-upper-octave-marker,
.cm-lower-octave-marker {
    opacity: 0;
    visibility: hidden;
}

/* Consumed elements - slightly greyish, no border */
.cm-consumed-slur-indicator,
.cm-consumed-upper-octave-marker {
    opacity: 0.4 !important;
    color: #ccc !important;
    background: transparent !important;
    border: none !important;
    padding: 0 !important;
}

/* Consumed lower octave marker - separate styling */
.cm-consumed-lower-octave-marker {
    opacity: 0.4 !important;
    color: #ccc !important;
    background: transparent !important;
    padding: 0 !important;
}

/* Red box border for consumed lower octave marker */
.cm-consumed-lower-octave-marker.consumed.cm-lower-octave-marker {
    border: 2px solid red !important;
}

/* Octave-specific styling using CSS classes */
/* Lower octave styling */
.octave-neg-1 {
    border: 2px solid orange !important;
}

.octave-neg-2 {
    border: 2px solid red !important;
}

.octave-neg-3 {
    border: 2px solid darkred !important;
}

/* Upper octave styling */
.octave-1 {
    border: 2px solid lightblue !important;
}

.octave-2 {
    border: 2px solid blue !important;
}

.octave-3 {
    border: 2px solid darkblue !important;
}

/* Slur arc - drawn on first element with slur consumed element and slur-char-loop-length */
/* Can be note, dash, breath mark, or whitespace */
.cm-note.consumed-slur[style*="--slur-char-loop-length"]::before,
.cm-dash.consumed-slur[style*="--slur-char-loop-length"]::before,
.cm-breath-mark.consumed-slur[style*="--slur-char-loop-length"]::before,
.cm-whitespace.consumed-slur[style*="--slur-char-loop-length"]::before {
    content: '' !important;
    position: absolute !important;
    top: -0.5em !important;  /* Position above the element */
    left: 0 !important;  /* Start at the left edge of the element */
    /* Calculate width based on number of characters in slur */
    width: calc(var(--slur-char-loop-length) * 1ch) !important;
    height: 0.25em !important;  /* Shallow arc like beat loops */
    border: 2px solid #d73a49 !important;  /* Red color for slur */
    border-bottom: none !important;  /* Remove bottom border for upside-down arc */
    border-top-left-radius: 50% 100% !important;  /* Upside-down arc */
    border-top-right-radius: 50% 100% !important;
    z-index: 10 !important;
    pointer-events: none !important;
}

/* Ensure notes are positioned for absolute children */
.cm-note {
    position: relative !important;
    display: inline-block !important;
}

/* Upper octave indicators using --octave custom property */
/* Single upper octave dot (+1) */
.cm-note[style*="--octave: 1"]::before,
.cm-note[style*="--octave:1"]::before {
    content: '•';
    position: absolute;
    top: -0.5em;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.2em;
    color: #0066cc;
    font-weight: bold;
    z-index: 11;
    pointer-events: none;
}

/* Double upper octave dots (+2) */
.cm-note[style*="--octave: 2"]::before,
.cm-note[style*="--octave:2"]::before {
    content: '••';
    position: absolute;
    top: -0.5em;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.2em;
    color: #0066cc;
    font-weight: bold;
    z-index: 11;
    pointer-events: none;
}

/* Triple upper octave dots (+3) */
.cm-note[style*="--octave: 3"]::before,
.cm-note[style*="--octave:3"]::before {
    content: '•••';
    position: absolute;
    top: -0.5em;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.2em;
    color: #0066cc;
    font-weight: bold;
    z-index: 11;
    pointer-events: none;
}

/* Lower octave indicators using --octave-negative custom property */
/* Single lower octave dot (-1) */
.cm-note[style*="--octave-negative: 1"]::after,
.cm-note[style*="--octave-negative:1"]::after {
    content: '•';
    position: absolute;
    bottom: -0.7em;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.2em;
    color: #cc6600;
    font-weight: bold;
    z-index: 11;
    pointer-events: none;
}

/* Double lower octave dots (-2) */
.cm-note[style*="--octave-negative: 2"]::after,
.cm-note[style*="--octave-negative:2"]::after {
    content: '••';
    position: absolute;
    bottom: -0.7em;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.2em;
    color: #cc6600;
    font-weight: bold;
    z-index: 11;
    pointer-events: none;
}

/* Triple lower octave dots (-3) */
.cm-note[style*="--octave-negative: 3"]::after,
.cm-note[style*="--octave-negative:3"]::after {
    content: '•••';
    position: absolute;
    bottom: -0.7em;
    left: 50%;
    transform: translateX(-50%);
    font-size: 1.2em;
    color: #cc6600;
    font-weight: bold;
    z-index: 11;
    pointer-events: none;
}