<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Text</title>

    <!-- Retro mode redirect -->
    <noscript>
        <meta http-equiv="refresh" content="0; url=/retro">
    </noscript>
    <script>
        // Check for retro mode query parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('retro') === 'true' || urlParams.get('nojs') === 'true') {
            window.location.href = '/retro';
        }
    </script>

    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <script src="js/vexflow-renderer.js"></script>
    <link rel="stylesheet" href="css/app.css">
</head>
<body>
    <div class="app">
        <div class="control-bar">
            <div class="controls">
            <div class="menu">
                <button class="control-button" id="fileMenuButton">File ▾</button>
                <div class="menu-dropdown" id="fileMenu" style="display:none; position:absolute; background:#fff; border:1px solid #ccc; box-shadow:0 2px 8px rgba(0,0,0,0.15); z-index:1000;">
                    <button class="menu-item" id="menuNewDoc">New</button>
                    <button class="menu-item" id="menuOpen">Open…</button>
                    <hr>
                    <button class="menu-item" id="menuImportMusicXML">Import MusicXML…</button>
                </div>
                <input type="file" id="musicxmlFileInput" accept=".musicxml,.xml,application/vnd.recordare.musicxml+xml" style="display:none" />
            </div>
                            <button id="newDocButton" class="control-button">New</button>
            <button id="clearButton" class="control-button">Clear</button>
            <button id="clearStorageButton" class="control-button" title="Clear localStorage">Clear Storage</button>
            <button id="copyButton" class="control-button">Copy</button>
            <button id="pasteButton" class="control-button">Paste</button>
            <button id="lilypondButton" class="control-button">LilyPond</button>
            <button id="playButton" class="control-button">Play</button>
            <button id="stopButton" class="control-button">Stop</button>


                <div class="octave-controls">
                    <span class="octave-label">Octave:</span>
                    <button onclick="applyOctaveAdjustment('lowest')" class="octave-btn" title="Lowest (: below)" disabled id="btn-lowest">LL</button>
                    <button onclick="applyOctaveAdjustment('lower')" class="octave-btn" title="Lower (. below)" disabled id="btn-lower">L</button>
                    <button onclick="applyOctaveAdjustment('middle')" class="octave-btn" title="Middle (remove octave marks)" disabled id="btn-middle">M</button>
                    <button onclick="applyOctaveAdjustment('higher')" class="octave-btn" title="Upper (. above)" disabled id="btn-higher">U</button>
                    <button onclick="applyOctaveAdjustment('highest')" class="octave-btn" title="Highest (: above)" disabled id="btn-highest">HH</button>
                </div>
                <div class="font-selector">
                    <label for="fontSelect">Font:</label>
                    <select id="fontSelect" onchange="changeFontFamily(this.value)">
                        <option value="font-default">Default Mono</option>
                        <option value="font-courier">Courier New</option>
                        <option value="font-source-code">Source Code Pro</option>
                        <option value="font-fira-code">Fira Code</option>
                        <option value="font-menlo">Menlo</option>
                    </select>
                </div>
            </div>
            <div id="status" class="status"></div>
        </div>
        
        <div id="canvasEditor" class="canvas-editor">
            <div id="svg-container" class="svg-container" tabindex="0"></div>
        </div>
        
        <div class="tabs">
            <div class="tab active" id="editor_svg" onclick="switchTab('editor_svg', this)">Editor</div>
            <div class="tab" id="vexflow_svg" onclick="switchTab('vexflow_svg', this)">VexFlow</div>
            <div class="tab" id="lilypond_svg" onclick="switchTab('lilypond_svg', this)">LilyPond SVG</div>
            <div class="tab" id="lilypond_src" onclick="switchTab('lilypond_src', this)">LilyPond Source</div>
            <div class="tab" id="document" onclick="switchTab('document', this)">Document</div>
            <div class="tab" id="midi" onclick="switchTab('midi', this)">MIDI</div>
        </div>
        
        <div id="editor_svg-tab" class="tab-content active">
            <div id="editor_svg-output" class="pipeline-section">Editor SVG source will appear here</div>
        </div>

        <div id="vexflow_svg-tab" class="tab-content">
            <div id="vexflow_svg-output">VexFlow SVG will appear here</div>
        </div>

        <div id="lilypond_svg-tab" class="tab-content">
            <div id="lilypond_svg-output">Click "LilyPond" to generate SVG</div>
        </div>

        <div id="lilypond_src-tab" class="tab-content">
            <div id="lilypond_src-output">Enter music notation to see LilyPond source</div>
        </div>
        
        <div id="document-tab" class="tab-content">
            <div id="document-output" class="pipeline-section">Enter music notation to see parsed document output</div>
        </div>

        <div id="midi-tab" class="tab-content">
            <div class="midi-tab-container">
                <div class="midi-controls">
                    <div class="midi-playback">
                        <button onclick="playMidi()" class="midi-btn play-btn" id="playBtn" title="Play MIDI">
                            <span class="midi-icon">▶️</span>
                            <span class="midi-label">Play</span>
                        </button>
                        <button onclick="pauseMidi()" class="midi-btn pause-btn" id="pauseBtn" title="Pause MIDI">
                            <span class="midi-icon">⏸️</span>
                            <span class="midi-label">Pause</span>
                        </button>
                        <button onclick="stopMidi()" class="midi-btn stop-btn" id="stopBtn" title="Stop MIDI">
                            <span class="midi-icon">⏹️</span>
                            <span class="midi-label">Stop</span>
                        </button>
                    </div>

                    <div class="midi-tempo">
                        <label for="tempoSlider">Tempo:</label>
                        <input type="range" id="tempoSlider" min="40" max="208" value="120" onchange="setTempo(this.value)" title="Tempo (BPM)">
                        <span id="tempoDisplay">120 BPM</span>
                    </div>

                    <div class="midi-info">
                        <div id="midiStatus" class="midi-status">Ready</div>
                        <div id="midiPosition" class="midi-position">0:00 / 0:00</div>
                    </div>
                </div>

                <div class="midi-visualization">
                    <canvas id="midiCanvas" width="800" height="200"></canvas>
                    <div id="midiOutput" class="midi-output">
                        Enter music notation to see MIDI representation and enable playback
                    </div>
                </div>
            </div>
        </div>


    </div></body>

    <script type="module" src="js/app.js"></script>
    <script>
    window.addEventListener('DOMContentLoaded', ()=>{

        const fileBtn = document.getElementById('fileMenuButton');
        const menu = document.getElementById('fileMenu');
        const importBtn = document.getElementById('menuImportMusicXML');
        const fileInput = document.getElementById('musicxmlFileInput');

        function closeMenuOnOutsideClick(e){
            if (!menu.contains(e.target) && e.target !== fileBtn) {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenuOnOutsideClick);
            }
        }

        fileBtn && fileBtn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const rect = fileBtn.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.top = (rect.bottom + window.scrollY) + 'px';
            menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
            if (menu.style.display === 'block') {
                setTimeout(()=> document.addEventListener('click', closeMenuOnOutsideClick), 0);
            }
        });

        importBtn && importBtn.addEventListener('click', ()=>{
            menu.style.display = 'none';
            fileInput.click();
        });

        fileInput && fileInput.addEventListener('change', async (e)=>{
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            try {
                UI.setStatus('Importing MusicXML…');
                const text = await file.text();
                // Default: prefer_minor false; could be a UI option later
                const res = await fetch('/api/import/musicxml', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ xml: text, prefer_minor: false })
                });
                if (!res.ok) {
                    const err = await res.json().catch(()=>({error: res.statusText}));
                    throw new Error(err.error || 'Import failed');
                }
                const data = await res.json();
                // Expecting { document }
                if (window.musicApp && window.musicApp.canvasEditor) {
                    await window.musicApp.canvasEditor.loadDocument(data.document);
                    UI.updateDocumentStatus();
                }
                UI.setStatus('MusicXML imported', 'success');
            } catch (err) {
                console.error('MusicXML import error', err);
                UI.setStatus(`Import failed: ${err.message}`, 'error');
            } finally {
                e.target.value = '';
            }
        });
    });
    </script>
</body>
</html>
