<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Notation WYSIWYG Editor</title>
    <style>
        body {
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            font-size: 14px;
            line-height: 1.42857143;
            color: #333;
            background-color: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #337ab7;
            margin-bottom: 30px;
            text-align: center;
        }
        
        /* Form Controls */
        .form-inline {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .form-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        label {
            font-weight: 700;
            margin-bottom: 0;
        }
        
        .form-control {
            padding: 6px 12px;
            font-size: 14px;
            line-height: 1.42857143;
            color: #555;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        select.form-control {
            height: 34px;
        }
        
        .btn {
            display: inline-block;
            padding: 6px 12px;
            margin: 2px;
            font-size: 14px;
            font-weight: 400;
            text-align: center;
            white-space: nowrap;
            cursor: pointer;
            background-image: none;
            border: 1px solid transparent;
            border-radius: 4px;
            user-select: none;
        }
        
        .btn-primary {
            color: #fff;
            background-color: #337ab7;
            border-color: #2e6da4;
        }
        
        .btn-primary:hover {
            background-color: #286090;
            border-color: #204d74;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        /* Metadata Section */
        .metadata-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .metadata-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .metadata-item {
            flex: 1;
            min-width: 200px;
        }
        
        /* Toolbar */
        .toolbar {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px 4px 0 0;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .toolbar-group {
            display: flex;
            gap: 3px;
            margin-right: 15px;
            border-right: 1px solid #ddd;
            padding-right: 15px;
        }
        
        .toolbar-group:last-child {
            border-right: none;
            margin-right: 0;
        }
        
        .toolbar-label {
            font-size: 12px;
            color: #666;
            margin-right: 5px;
            align-self: center;
        }
        
        /* Editor */
        .editor-container {
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        
        .music-editor {
            padding: 20px;
            min-height: 200px;
            font-size: 16px;
            line-height: 2.5; /* Space for slurs */
            font-family: 'Courier New', monospace;
            outline: none;
            background: white;
            white-space: pre-wrap;
        }
        
        .music-editor:focus {
            background: #fafafa;
        }
        
        /* Musical Elements */
        .slur {
            position: relative;
            display: inline-block;
            border-top: 2px solid black;
            border-radius: 50% / 100% 100% 0 0;
            padding-top: 0.4em;
            margin-top: -0.4em;
        }
        
        .slur::before,
        .slur::after {
            content: '';
            position: absolute;
            top: 0;
            width: 1px;
            height: 0.4em;
            background: white;
        }
        
        .slur::before { left: -1px; }
        .slur::after { right: -1px; }
        
        .underline {
            text-decoration: underline;
            text-decoration-thickness: 2px;
        }
        
        .barline {
            font-weight: bold;
            color: #666;
            margin: 0 0.3em;
            border-left: 1px solid #999;
            border-right: 1px solid #999;
            padding: 0 0.2em;
            background: #f0f0f0;
        }
        
        .double-barline {
            font-weight: bold;
            color: #666;
            margin: 0 0.3em;
            border-left: 3px double #999;
            border-right: 3px double #999;
            padding: 0 0.2em;
            background: #f0f0f0;
        }
        
        /* Octave indicators */
        .upper-octave-1 {
            position: relative;
        }
        
        .upper-octave-1::before {
            content: 'â€¢';
            position: absolute;
            top: -0.8em;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
        }
        
        .lower-octave-1 {
            position: relative;
        }
        
        .lower-octave-1::after {
            content: 'â€¢';
            position: absolute;
            bottom: -0.8em;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
        }
        
        .upper-octave-2::before {
            content: 'â€¢â€¢';
        }
        
        .lower-octave-2::after {
            content: 'â€¢â€¢';
        }
        
        /* Lyrics */
        .note-with-lyric {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        
        .note-with-lyric::after {
            content: attr(data-lyric);
            position: absolute;
            bottom: -1.5em;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: #666;
            font-style: italic;
            white-space: nowrap;
            pointer-events: none;
        }
        
        .note-with-lyric[data-lyric=""]::after {
            display: none;
        }
        
        /* Lyric Editor */
        .lyric-editor {
            position: absolute;
            background: white;
            border: 2px solid #337ab7;
            border-radius: 4px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .lyric-editor input {
            border: none;
            outline: none;
            padding: 2px;
            font-size: 12px;
            width: 60px;
        }
        
        /* Output Section */
        .output-section {
            margin-top: 30px;
        }
        
        .output-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
        }
        
        .output-tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            background: #f8f9fa;
            margin-right: 2px;
        }
        
        .output-tab.active {
            background: white;
            border-color: #ddd;
            border-bottom-color: white;
        }
        
        .output-content {
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            padding: 15px;
            min-height: 200px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        
        .debug-info {
            background: #ffe6e6;
            padding: 10px;
            margin: 10px 0;
            border-left: 3px solid #ff4444;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¼ Music Notation WYSIWYG Editor</h1>
        
        <!-- Metadata Section -->
        <div class="metadata-section">
            <div class="metadata-row">
                <div class="metadata-item">
                    <label for="compositionTitle">Title:</label>
                    <input type="text" id="compositionTitle" class="form-control" placeholder="Enter composition title">
                </div>
                <div class="metadata-item">
                    <label for="compositionKey">Key:</label>
                    <select id="compositionKey" class="form-control">
                        <option value="">Select Key</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="G">G</option>
                        <option value="A">A</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <div class="metadata-item">
                    <label for="notationType">Notation Type:</label>
                    <select id="notationType" class="form-control">
                        <option value="number">Number (1234567)</option>
                        <option value="sargam">Sargam (SRGmPDN)</option>
                        <option value="western">Western (CDEFGAB)</option>
                        <option value="doremi">DoReMi (DRMFSLT)</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-group">
                <span class="toolbar-label">Format:</span>
                <button class="btn btn-secondary" onclick="format('bold')" title="Bold">B</button>
                <button class="btn btn-secondary" onclick="toggleStyle('underline')" title="Underline">U</button>
            </div>
            
            <div class="toolbar-group">
                <span class="toolbar-label">Musical:</span>
                <button class="btn btn-secondary" onclick="toggleStyle('slur')" title="Add Slur">âŒ’</button>
                <button class="btn btn-secondary" onclick="insertBarline()" title="Insert Barline">|</button>
                <button class="btn btn-secondary" onclick="insertDoubleBarline()" title="Insert Double Barline">||</button>
            </div>
            
            <div class="toolbar-group">
                <span class="toolbar-label">Octaves:</span>
                <button class="btn btn-secondary" onclick="toggleOctave('upper', 1)" title="Upper Octave">Ë™</button>
                <button class="btn btn-secondary" onclick="toggleOctave('lower', 1)" title="Lower Octave">.</button>
                <button class="btn btn-secondary" onclick="toggleOctave('upper', 2)" title="Upper Octave x2">Â¨</button>
                <button class="btn btn-secondary" onclick="toggleOctave('lower', 2)" title="Lower Octave x2">..</button>
            </div>
            
            <div class="toolbar-group">
                <span class="toolbar-label">Lyrics:</span>
                <button class="btn btn-secondary" onclick="toggleLyricMode()" title="Add/Edit Lyrics" id="lyricBtn">â™ª Lyrics</button>
                <button class="btn btn-secondary" onclick="clearAllLyrics()" title="Clear All Lyrics">Clear</button>
            </div>
            
            <div class="toolbar-group">
                <span class="toolbar-label">Actions:</span>
                <button class="btn btn-primary" onclick="convertToMusicText()" title="Convert to Music-Text">Convert</button>
                <button class="btn btn-secondary" onclick="clearEditor()" title="Clear All">Clear All</button>
            </div>
        </div>
        
        <!-- Music Editor -->
        <div class="editor-container">
            <div id="musicEditor" class="music-editor" contenteditable="true" spellcheck="false">
Select text and use the toolbar above to add slurs, octave markings, barlines, and lyrics.
Try typing: 1 2 3 4 5 6 7
            </div>
        </div>
        
        <!-- Output Section -->
        <div class="output-section">
            <h3>Output</h3>
            <div class="output-tabs">
                <div class="output-tab active" onclick="showOutputTab('music-text')">Music-Text</div>
                <div class="output-tab" onclick="showOutputTab('fsm-tokens')">FSM Tokens</div>
                <div class="output-tab" onclick="showOutputTab('debug')">Debug Info</div>
            </div>
            <div id="outputContent" class="output-content"></div>
        </div>
    </div>

    <!-- Lyric Editor (Hidden by default) -->
    <div id="lyricEditor" class="lyric-editor" style="display: none;">
        <input type="text" id="lyricInput" placeholder="Enter lyric">
        <button onclick="saveLyric()">Save</button>
        <button onclick="cancelLyric()">Cancel</button>
    </div>

    <script>
        let lyricMode = false;
        let currentEditingElement = null;
        let activeOutputTab = 'music-text';
        
        // Initialize
        document.getElementById('musicEditor').addEventListener('click', handleEditorClick);
        document.getElementById('musicEditor').addEventListener('input', handleEditorInput);
        
        function format(command) {
            document.execCommand(command, false, null);
            updateOutput();
        }
        
        function toggleStyle(styleClass) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const range = selection.getRangeAt(0);
            const selectedText = selection.toString();
            
            if (!selectedText) return;
            
            // Check if already styled
            const container = range.commonAncestorContainer;
            const parentElement = container.nodeType === Node.ELEMENT_NODE ? container : container.parentNode;
            
            if (parentElement.classList && parentElement.classList.contains(styleClass)) {
                // Remove style
                const textNode = document.createTextNode(parentElement.textContent);
                parentElement.parentNode.replaceChild(textNode, parentElement);
                
                // Restore selection
                const newRange = document.createRange();
                newRange.selectNodeContents(textNode);
                selection.removeAllRanges();
                selection.addRange(newRange);
            } else {
                // Add style
                const span = document.createElement('span');
                span.className = styleClass;
                span.textContent = selectedText;
                
                range.deleteContents();
                range.insertNode(span);

                // Reselect
                selection.removeAllRanges();
                const newRange = document.createRange();
                newRange.selectNodeContents(span);
                selection.addRange(newRange);
            }
            
            updateOutput();
        }
        
        function toggleOctave(direction, level) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;

            const selectedText = selection.toString();
            if (!selectedText) return;

            const noteChars = /[1-7CDEFGABSRGMPDNcdefgabsrgmpdn]/;
            const className = direction + '-octave-' + level;
            
            // Process character by character
            const range = selection.getRangeAt(0);
            const span = document.createElement('span');
            
            let newHTML = '';
            for (let char of selectedText) {
                if (noteChars.test(char)) {
                    newHTML += `<span class="${className}">${char}</span>`;
                } else {
                    newHTML += char;
                }
            }
            
            range.deleteContents();
            span.innerHTML = newHTML;
            range.insertNode(span);
            
            // Clean up - replace span with its contents
            while (span.firstChild) {
                span.parentNode.insertBefore(span.firstChild, span);
            }
            span.parentNode.removeChild(span);
            
            updateOutput();
        }
        
        function insertBarline() {
            insertAtCursor('<span class="barline">|</span>');
            updateOutput();
        }
        
        function insertDoubleBarline() {
            insertAtCursor('<span class="double-barline">||</span>');
            updateOutput();
        }
        
        function insertAtCursor(html) {
            const selection = window.getSelection();
            if (selection.getRangeCount()) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                const div = document.createElement('div');
                div.innerHTML = html;
                const frag = document.createDocumentFragment();
                while (div.firstChild) {
                    frag.appendChild(div.firstChild);
                }
                range.insertNode(frag);
            }
        }
        
        function toggleLyricMode() {
            lyricMode = !lyricMode;
            const btn = document.getElementById('lyricBtn');
            if (lyricMode) {
                btn.textContent = 'â™ª Lyrics (ON)';
                btn.style.background = '#337ab7';
                btn.style.color = 'white';
                document.getElementById('musicEditor').style.cursor = 'crosshair';
            } else {
                btn.textContent = 'â™ª Lyrics';
                btn.style.background = '';
                btn.style.color = '';
                document.getElementById('musicEditor').style.cursor = '';
            }
        }
        
        function handleEditorClick(event) {
            if (lyricMode) {
                const target = event.target;
                const noteChars = /[1-7CDEFGABSRGMPDNcdefgabsrgmpdn]/;
                
                if (noteChars.test(target.textContent)) {
                    editLyric(target);
                }
                event.preventDefault();
            }
        }
        
        function handleEditorInput() {
            // Auto-wrap note characters for lyric attachment
            setTimeout(updateOutput, 100);
        }
        
        function editLyric(element) {
            currentEditingElement = element;
            
            // Wrap in lyric span if not already
            if (!element.classList.contains('note-with-lyric')) {
                const span = document.createElement('span');
                span.className = 'note-with-lyric';
                span.textContent = element.textContent;
                span.setAttribute('data-lyric', element.getAttribute('data-lyric') || '');
                element.parentNode.replaceChild(span, element);
                currentEditingElement = span;
            }
            
            const lyricEditor = document.getElementById('lyricEditor');
            const lyricInput = document.getElementById('lyricInput');
            
            // Position editor below the note
            const rect = currentEditingElement.getBoundingClientRect();
            lyricEditor.style.display = 'block';
            lyricEditor.style.left = rect.left + 'px';
            lyricEditor.style.top = (rect.bottom + window.scrollY + 5) + 'px';
            
            lyricInput.value = currentEditingElement.getAttribute('data-lyric') || '';
            lyricInput.focus();
            lyricInput.select();
        }
        
        function saveLyric() {
            if (currentEditingElement) {
                const lyricInput = document.getElementById('lyricInput');
                currentEditingElement.setAttribute('data-lyric', lyricInput.value);
            }
            cancelLyric();
            updateOutput();
        }
        
        function cancelLyric() {
            document.getElementById('lyricEditor').style.display = 'none';
            currentEditingElement = null;
        }
        
        function clearAllLyrics() {
            const lyricElements = document.querySelectorAll('.note-with-lyric');
            lyricElements.forEach(el => {
                el.removeAttribute('data-lyric');
                el.classList.remove('note-with-lyric');
            });
            updateOutput();
        }
        
        function clearEditor() {
            document.getElementById('musicEditor').innerHTML = 'Type your music notation here...';
            updateOutput();
        }
        
        function showOutputTab(tabName) {
            // Update tab appearance
            document.querySelectorAll('.output-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            activeOutputTab = tabName;
            updateOutput();
        }
        
        function updateOutput() {
            const editor = document.getElementById('musicEditor');
            const outputContent = document.getElementById('outputContent');
            
            try {
                const result = convertToMusicText();
                
                switch (activeOutputTab) {
                    case 'music-text':
                        outputContent.textContent = result.musicText || 'No output generated';
                        break;
                    case 'fsm-tokens':
                        outputContent.textContent = JSON.stringify(result.tokens, null, 2);
                        break;
                    case 'debug':
                        outputContent.innerHTML = `
                            <div class="debug-info">
                                <strong>DOM Structure:</strong><br>
                                ${editor.innerHTML}
                            </div>
                            <div class="debug-info">
                                <strong>Conversion Log:</strong><br>
                                ${result.debug || 'No debug info'}
                            </div>
                        `;
                        break;
                }
            } catch (error) {
                outputContent.innerHTML = `<div class="debug-info">Error: ${error.message}</div>`;
            }
        }
        
        function convertToMusicText() {
            const editor = document.getElementById('musicEditor');
            const title = document.getElementById('compositionTitle').value;
            const key = document.getElementById('compositionKey').value;
            const notationType = document.getElementById('notationType').value;
            
            const tokens = [];
            const debug = [];
            let musicText = '';
            
            // Add metadata
            if (title) musicText += `title: ${title}\n`;
            if (key) musicText += `key: ${key}\n`;
            if (notationType && notationType !== 'number') musicText += `notation: ${notationType}\n`;
            if (musicText) musicText += '\n';
            
            // Process DOM to extract music notation
            let position = 0;
            
            function processNode(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    for (let char of text) {
                        if (/[1-7CDEFGABSRGMPDNcdefgabsrgmpdn]/.test(char)) {
                            tokens.push({
                                type: 'Note',
                                value: char,
                                position: position++,
                                lyric: null
                            });
                            musicText += char;
                        } else if (char === '-') {
                            tokens.push({
                                type: 'Dash',
                                position: position++
                            });
                            musicText += char;
                        } else if (char === ' ') {
                            tokens.push({
                                type: 'Space',
                                position: position++
                            });
                            musicText += char;
                        } else if (char.trim() === '') {
                            // Skip whitespace
                        } else {
                            musicText += char;
                        }
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    const element = node;
                    
                    if (element.classList.contains('slur')) {
                        // Process slurred notes with underscores
                        const notes = [];
                        processNode(element); // Get the notes
                        // Add underscores between notes (simplified)
                        // This would need more sophisticated processing
                        debug.push(`Found slur over: ${element.textContent}`);
                    } else if (element.classList.contains('note-with-lyric')) {
                        const lyric = element.getAttribute('data-lyric');
                        const noteChar = element.textContent.trim();
                        
                        if (/[1-7CDEFGABSRGMPDNcdefgabsrgmpdn]/.test(noteChar)) {
                            tokens.push({
                                type: 'Note',
                                value: noteChar,
                                position: position++,
                                lyric: lyric || null
                            });
                            musicText += noteChar;
                            if (lyric) {
                                debug.push(`Note ${noteChar} has lyric: ${lyric}`);
                            }
                        }
                    } else if (element.classList.contains('barline')) {
                        tokens.push({
                            type: 'Barline',
                            value: '|',
                            position: position++
                        });
                        musicText += ' | ';
                    } else if (element.classList.contains('double-barline')) {
                        tokens.push({
                            type: 'DoubleBarline',
                            value: '||',
                            position: position++
                        });
                        musicText += ' || ';
                    } else if (element.classList.contains('upper-octave-1')) {
                        const noteChar = element.textContent.trim();
                        tokens.push({
                            type: 'Note',
                            value: noteChar + "'",
                            octave: 1,
                            position: position++
                        });
                        musicText += noteChar + "'";
                    } else if (element.classList.contains('lower-octave-1')) {
                        const noteChar = element.textContent.trim();
                        tokens.push({
                            type: 'Note',
                            value: noteChar + ",",
                            octave: -1,
                            position: position++
                        });
                        musicText += noteChar + ",";
                    } else {
                        // Process child nodes
                        for (let child of element.childNodes) {
                            processNode(child);
                        }
                    }
                }
            }
            
            // Process all nodes in the editor
            for (let node of editor.childNodes) {
                processNode(node);
            }
            
            return {
                musicText: musicText.trim(),
                tokens: tokens,
                debug: debug.join('\n')
            };
        }
        
        // Handle Enter key in lyric editor
        document.getElementById('lyricInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                saveLyric();
            } else if (event.key === 'Escape') {
                cancelLyric();
            }
        });
        
        // Initial output update
        updateOutput();
    </script>
</body>
</html>