# Development Tools & Workflow Guide

## Overview
This document outlines the current development environment setup for the Music-Text project, including available commands, known issues, and recommended workflows.

## Architecture Summary
- **Backend**: Rust with Axum web server
- **Frontend**: JavaScript with VexFlow and LilyPond rendering
- **Grammar**: Pest parser with multiple notation systems
- **Build System**: Cargo + Make
- **Testing**: Playwright for browser automation + Cargo tests

## Available Development Commands

### Core Development Commands

#### 1. `make dev` - Full Tmux Environment
**Description**: Complete development environment with multiple panes
- **Left pane**: Web server with auto-restart (`cargo watch --quiet --exec 'run -- --web'`)
- **Top right**: Test watcher (`cargo watch --quiet --exec test`)
- **Bottom right**: Manual browser test commands
- **Second tab**: Manual commands window

**Usage**:
```bash
make dev
# Creates tmux session 'dev'
# Ctrl+B, D to detach
# tmux attach -t dev to reattach
```

#### 2. `make dev-simple` - No Tmux Setup
**Description**: Simple development without tmux complexity
- Shows commands to run in separate terminals
- Option to start web server watcher immediately

**Usage**:
```bash
make dev-simple
# Follow the displayed instructions
```

#### 3. `make dev-server` - Web Server Only
**Description**: Just the web server with auto-restart
```bash
make dev-server
# cargo watch --quiet --exec 'run -- --web'
```

#### 4. `make dev-test` - Test Watcher Only
**Description**: Auto-run tests on file changes
```bash
make dev-test
# cargo watch --quiet --exec test
```

#### 5. `make dev-quiet` - Minimal Output
**Description**: Quieter server with reduced output
```bash
make dev-quiet
# cargo watch --quiet --no-vcs-ignores --exec 'run -- --web' 2>/dev/null
```

### Build & Test Commands

#### Core Build
```bash
make build          # Build CLI binary
make build-cli      # Same as above
make test           # Run all tests (Rust + consistency)
make test-rust      # Rust tests only
make clean          # Clean build artifacts
```

#### Quality & Formatting
```bash
make lint           # cargo fmt --check + clippy
make format         # cargo fmt
make ci             # Full CI pipeline (clean + build + test + lint)
```

#### Cache Management
```bash
make cache-bust     # Update web asset versions
```

### Direct Cargo Commands
```bash
cargo build --release              # Production build
cargo run -- --web                # Start web server
cargo test                         # Run tests
cargo watch -x 'run -- --web'     # Auto-restart server
cargo watch -x test               # Auto-run tests
```

### Browser Testing
```bash
npx playwright test                # Run all browser tests
npx playwright test --headed      # Run with visible browser
npx playwright test --debug       # Interactive debugging
npx playwright codegen           # Record browser interactions
```

## File Structure

### Key Development Files
```
.
├── src/                          # Rust source code
│   ├── web_server.rs            # Axum server + API endpoints
│   ├── parser.rs                # Core parser logic
│   ├── ast.rs                   # Abstract Syntax Tree
│   └── grammar/                 # Pest grammar files
├── webapp/
│   ├── public/
│   │   ├── index.html          # Main web interface
│   │   ├── js/app.js           # Frontend JavaScript
│   │   └── css/app.css         # Styles
│   └── update-cache-bust.js    # Cache-busting script
├── grammar/
│   ├── notation.pest           # Generated grammar (DO NOT EDIT)
│   ├── notation.pest.template  # Grammar template (EDIT THIS)
│   └── systems.json            # Notation system configurations
├── tests/                      # Playwright browser tests
├── Makefile                    # Development commands
├── dev.sh                      # Tmux development setup
├── dev-simple.sh              # Simple development setup
└── DEV_TOOLS.md               # This file
```

### Generated Files (Do Not Edit)
- `grammar/notation.pest` - Generated by `build.rs` from template
- Web asset versions are auto-generated

## Development Server Details

### Web Server Endpoints
- **Web UI**: http://localhost:3000/
- **Parse API**: POST http://localhost:3000/api/parse
- **AST Only**: POST http://localhost:3000/api/parse/ast
- **Full Parse**: POST http://localhost:3000/api/parse/full
- **Health Check**: GET http://localhost:3000/health

### Cache-Busting System
- Automatically updates asset versions on server start
- Uses MD5 hashes of file content for version numbers
- Script location: `webapp/update-cache-bust.js`

## Known Issues & Solutions

### 1. Infinite Loop in Development Environment
**Symptoms**: `make dev` causes continuous rebuilds and high CPU usage

**Likely Causes**:
- `cargo-watch` detecting build artifacts and triggering rebuilds
- File system watching issues with temporary files
- Circular dependencies in watch patterns

**Workarounds**:
```bash
# Use more stable alternatives:
make dev-server     # Most stable - just web server
make dev-simple     # Manual terminal management

# For debugging:
cargo watch --why   # Shows what files trigger rebuilds
```

### 2. Parsing Issue: "1" Parsed as Upper Line Symbol
**Current Status**: Still unresolved
- Input "1" should be parsed as content line (musical note)
- Currently being parsed as upper line Symbol (annotation)
- Grammar changes attempted but issue persists

**Investigation Notes**:
- Check `number_upper_line` vs `number_content_line` rules
- Ornament definitions may still allow bare pitches
- Need to examine parser precedence rules

### 3. Background Process Management
**Issue**: Multiple cargo/node processes can conflict

**Solution**:
```bash
# Clean slate before development:
pkill -f "cargo.*web"
pkill -f "node.*start"
make clean
make dev-server
```

### 4. Compiler Warnings Noise
**Issue**: Many unused import/dead code warnings during development

**Status**: Warnings don't affect functionality but create noise
**Future**: Consider conditional compilation flags for development

## Recommended Development Workflow

### For Daily Development (Most Stable)
```bash
# Terminal 1: Clean start
make clean
make dev-server

# Terminal 2: Tests when needed
make dev-test

# Terminal 3: Browser tests
npx playwright test --headed
```

### For Full Environment (When Stable)
```bash
make dev  # Full tmux setup
```

### For Quick Changes
```bash
make dev-quiet  # Minimal output
```

## Grammar Development

### Grammar System
- **Template**: Edit `grammar/notation.pest.template`
- **Generated**: `grammar/notation.pest` (auto-generated)
- **Build**: `build.rs` processes template + `systems.json`
- **Systems**: Number, Sargam, Western, ABC, Doremi notation

### Grammar Debugging
```bash
# Rebuild grammar after template changes:
cargo build

# Test specific inputs:
cargo run -- --input "1" --output ast
```

## Testing Strategy

### Unit Tests
```bash
cargo test                    # All Rust tests
cargo test --lib              # Library tests only
cargo test cross_platform     # Consistency tests
```

### Browser Tests
```bash
npx playwright test           # All browser tests
npx playwright test --headed  # Visual debugging
npx playwright test --debug   # Step-by-step debugging
```

### Manual Testing
- Use web interface at http://localhost:3000
- Test different notation systems (Number, Sargam, Western)
- Verify parsing outputs (AST, FSM, LilyPond, VexFlow)

## Troubleshooting

### Server Won't Start
1. Check if port 3000 is available: `lsof -i :3000`
2. Kill existing processes: `pkill -f "cargo.*web"`
3. Clean build: `make clean && make build`

### Grammar Changes Not Applied
1. Verify editing `notation.pest.template` not `notation.pest`
2. Rebuild: `cargo build` (triggers `build.rs`)
3. Restart server to reload grammar

### Tests Failing
1. Check server is running: `curl http://localhost:3000/health`
2. Update browser dependencies: `npx playwright install`
3. Run tests with debugging: `npx playwright test --debug`

### Cache Issues
1. Force cache update: `make cache-bust`
2. Hard refresh browser: Ctrl+Shift+R
3. Clear browser cache completely

## Performance Notes

- **Build Time**: Release builds take longer but are necessary for accurate testing
- **Watch Performance**: `cargo-watch` can be CPU intensive with large codebases
- **Browser Tests**: Playwright tests are slower than unit tests but provide integration coverage

## Future Improvements

1. **Resolve infinite loop** in `make dev` command
2. **Fix parsing issue** with single digit inputs
3. **Reduce compiler warnings** for cleaner development output
4. **Add hot reload** for frontend assets
5. **Optimize grammar** for faster parsing
6. **Add development database** for testing complex scenarios

---

**Last Updated**: 2025-09-04  
**Version**: Current development state documentation